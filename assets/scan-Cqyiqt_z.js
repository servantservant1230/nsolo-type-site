import"./styles-BufaHF3D.js";const k=[{slug:"youngsoo",label:"영수",desc:"계획형·현실감각",gender:"male"},{slug:"youngho",label:"영호",desc:"부드러운 리더형",gender:"male"},{slug:"youngsik",label:"영식",desc:"센스·눈치 빠름",gender:"male"},{slug:"youngchul",label:"영철",desc:"직진·추진형",gender:"male"},{slug:"kwangsoo",label:"광수",desc:"개성·집중형",gender:"male"},{slug:"sangchul",label:"상철",desc:"안정·책임형",gender:"male"},{slug:"oksoon",label:"옥순",desc:"존재감·자신감형",gender:"female"},{slug:"youngsook",label:"영숙",desc:"배려·균형형",gender:"female"},{slug:"soonja",label:"순자",desc:"담백·차분형",gender:"female"},{slug:"youngja",label:"영자",desc:"솔직·쿨형",gender:"female"},{slug:"jungsook",label:"정숙",desc:"신중·정리형",gender:"female"},{slug:"hyunsook",label:"현숙",desc:"밝음·사교형",gender:"female"}];function q(t){const e=Math.max(...t),n=t.map(a=>Math.exp(a-e)),o=n.reduce((a,s)=>a+s,0);return n.map(a=>a/o)}const j=k.map((t,e)=>[Math.sin(e+1)*.8,Math.cos(e+2)*.7,Math.sin(e+3)*.6,Math.cos(e+4)*.5,Math.sin(e+5)*.4,Math.cos(e+6)*.3,Math.sin(e+7)*.2,Math.cos(e+8)*.1]),A=k.map((t,e)=>[Math.sin(e*.61),Math.cos(e*.73),Math.sin(e*.47),Math.cos(e*.59),Math.sin(e*.31),Math.cos(e*.43),Math.sin(e*.23),Math.cos(e*.17)]);function z(t,e){let n=0;for(let o=0;o<8;o++)n+=(t[o]??0)*(e[o]??0);return n}function L(t){const e=t.reduce((a,s)=>a+s,0)/t.length,n=t.reduce((a,s)=>a+(s-e)**2,0)/t.length,o=Math.sqrt(n)||1;return t.map(a=>(a-e)/o)}function E(t,e=.75,n=.25){const o=L(t);return j.map((a,s)=>e*z(a,o)+n*z(A[s],o))}function G(t,e){return new Set(["oksoon","hyunsook","youngja","youngho","youngsik","youngchul"]).has(t)?.01:e==="male"?.09:0}function P(t,e){const n=t.map(c=>({...c,p:Math.max(0,c.p+G(c.slug,e))})),o=n.reduce((c,l)=>c+l.p,0)||1,a=n.map(c=>({...c,p:c.p/o})),s=.18,d=1/a.length;return a.map(c=>({...c,p:(1-s)*c.p+s*d}))}function O(t,e){const n=q(E(t)),o=k.map((a,s)=>({...a,p:n[s]})).filter(a=>a.gender===e);return P(o,e).sort((a,s)=>s.p-a.p).slice(0,3)}function T(t){const e=t.data;let n=0,o=0,a=0,s=0,d=0;const c=e.length/4,l=t.width;for(let r=0;r<e.length;r+=4){const y=e[r],M=e[r+1],w=e[r+2],m=.299*y+.587*M+.114*w,x=Math.max(y,M,w),R=Math.min(y,M,w);n+=m,d+=x===0?0:(x-R)/x,r/4%l<l/2?a+=m:s+=m,r>4&&(o+=Math.abs(m-(.299*e[r-4]+.587*e[r-3]+.114*e[r-2])))}n/=c,a/=c/2,s/=c/2,d/=c;const h=Math.abs(a-s)/255;return[n/255,(a-s)/255,o/(c*255),(a+s)/510,d,h,Math.sin(o/100),Math.cos(n/50)]}const C=document.querySelector("#upload"),U=document.querySelector("#genderValue"),v=Array.from(document.querySelectorAll("[data-gender-btn]")),u=document.querySelector("#preview"),p=document.querySelector("#analyze"),g=document.querySelector("#status"),f=u.getContext("2d",{willReadFrequently:!0});let b=!1;const F=new URLSearchParams(location.search).get("lang")||"ko",D={ko:{uploadGuide:"사진을 업로드해 주세요.",uploadDone:"사진 업로드 완료 (얼굴 중심 정렬)",uploadDoneSimple:"사진 업로드 완료",needUpload:"먼저 사진을 업로드해 주세요.",analyzing:"분석 중...",analyze:"분석하기"},en:{uploadGuide:"Please upload a photo.",uploadDone:"Upload complete (face-centered).",uploadDoneSimple:"Upload complete.",needUpload:"Please upload a photo first.",analyzing:"Analyzing...",analyze:"Analyze"},ja:{uploadGuide:"写真をアップロードしてください。",uploadDone:"アップロード完了（顔中心に調整）",uploadDoneSimple:"アップロード完了",needUpload:"先に写真をアップロードしてください。",analyzing:"分析中...",analyze:"分析する"}},i=D[F]||D.ko;g.textContent=i.uploadGuide;p.textContent=i.analyze;function _(t){const n=t.map(l=>Math.pow(Math.max(l.p,1e-6),1.3888888888888888)),o=n.reduce((l,h)=>l+h,0)||1,s=n.map(l=>l/o*100).map(l=>Math.round(l*10)/10),d=s.reduce((l,h)=>l+h,0),c=Math.round((100-d)*10)/10;return s[0]=Math.max(0,Math.round((s[0]+c)*10)/10),t.map((l,h)=>({...l,p:s[h]}))}function I(t){U.value=t,v.forEach(e=>{const n=e.dataset.gender===t;e.classList.toggle("active",n),e.classList.toggle("secondary",n)})}v.forEach(t=>{t.onclick=()=>I(t.dataset.gender||"female")});I("female");function S(t){const e=Math.min(t.width,t.height),n=(t.width-e)/2,o=(t.height-e)/2;f.clearRect(0,0,u.width,u.height),f.drawImage(t,n,o,e,e,0,0,u.width,u.height)}async function N(t){const e=window.FaceDetector;if(!e)return S(t);const o=await new e({fastMode:!0,maxDetectedFaces:1}).detect(t);if(!o?.length)return S(t);const a=o[0].boundingBox,s=.35,d=a.x+a.width/2,c=a.y+a.height/2,l=Math.max(a.width,a.height)*(1+s*2),h=Math.max(0,Math.min(t.width-l,d-l/2)),r=Math.max(0,Math.min(t.height-l,c-l/2));f.clearRect(0,0,u.width,u.height),f.drawImage(t,h,r,l,l,0,0,u.width,u.height)}C.onchange=async()=>{const t=C.files?.[0];if(!t)return;const e=URL.createObjectURL(t),n=new Image;n.onload=async()=>{try{await N(n),b=!0,g.textContent=i.uploadDone}catch{S(n),b=!0,g.textContent=i.uploadDoneSimple}finally{URL.revokeObjectURL(e)}},n.src=e};p.onclick=()=>{if(!b){g.textContent=i.needUpload;return}p.disabled=!0,g.textContent=i.analyzing;const t=U.value||"female",e=224,n=224,o=document.createElement("canvas");o.width=e,o.height=n,o.getContext("2d").drawImage(u,0,0,e,n);const a=o.getContext("2d").getImageData(0,0,e,n),s=T(a),d=O(s,t),c=_(d);sessionStorage.setItem("nsolo_result",JSON.stringify(c)),sessionStorage.setItem("nsolo_gender",t),p.disabled=!1,window.location.href=`/result.html?lang=${encodeURIComponent(F)}`};
